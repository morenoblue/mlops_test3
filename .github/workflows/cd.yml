name: CD (train→staging→prod canary)

on:
  workflow_run:
    workflows: ["CI (build+smoke+push)"]
    types: [completed]

jobs:
  train_big:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event != 'pull_request' }}
    runs-on: [self-hosted, trainer]
    outputs:
      PROMOTE: ${{ steps.promote.outputs.PROMOTE }}
    steps:
      - uses: actions/checkout@v4

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull train image
        run: docker pull ghcr.io/${{ github.repository }}:training-${{ github.event.workflow_run.head_sha }}

      - name: Big train (register + maybe alias=staging)
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          HOME_DIR: ${{ env.HOME }}
        run: |
          docker run --rm --network host \
            -v "$HOME/train_data:/data:ro" \
            -e MLFLOW_TRACKING_URI="${MLFLOW_TRACKING_URI}" \
            -e DATA_PATH="/data" \
            -e TRAIN_NROWS="1000" \
            ghcr.io/${{ github.repository }}:training-${{ github.event.workflow_run.head_sha }} | tee out.txt

      - name: Output promote flag
        id: promote
        run: |
          v=$(grep -o 'PROMOTE=[01]' out.txt | tail -n1 | cut -d= -f2 || echo 1)
          echo "PROMOTE=$([ "$v" = "1" ] && echo true || echo false)" >> $GITHUB_OUTPUT

  staging:
    needs: [train_big]
    if: ${{ needs.train_big.outputs.PROMOTE == 'true' }}
    runs-on: [self-hosted, staging]
    steps:
      - uses: actions/checkout@v4

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull serve image
        run: docker pull ghcr.io/${{ github.repository }}:serving-${{ github.event.workflow_run.head_sha }}

      - name: Run serving (staging alias)
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
        run: |
          docker rm -f model-staging || true
          docker run -d --name model-staging -p 8000:8000 \
            -e MLFLOW_TRACKING_URI="${MLFLOW_TRACKING_URI}" \
            -e MODEL_NAME="taxi-duration" \
            -e MODEL_ALIAS_STABLE="production" \
            -e MODEL_ALIAS_CAND="staging" \
            ghcr.io/${{ github.repository }}:serving-${{ github.event.workflow_run.head_sha }}
          sleep 3
          curl -fsS http://localhost:8000/health
          curl -fsS -X POST http://localhost:8000/predict \
            -H "Content-Type: application/json" \
            -d '{"records":[{"vendor_id":1,"pickup_datetime":"2010-01-15T08:30:00","dropoff_datetime":"2010-01-15T08:45:00","passenger_count":1,"trip_distance":2.3,"pickup_longitude":-73.99,"pickup_latitude":40.73,"rate_code":1,"dropoff_longitude":-73.98,"dropoff_latitude":40.75,"fare_amount":12.5,"surcharge":0.5,"mta_tax":0.5,"tip_amount":2.0,"tolls_amount":0.0,"total_amount":15.5,"store_and_fwd_flag":"N","payment_type":"CRD"}]}'

  prod_canary:
    needs: [train_big, staging]
    if: ${{ needs.train_big.outputs.PROMOTE == 'true' }}
    runs-on: [self-hosted, production]
    steps:
      - uses: actions/checkout@v4

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull serve image
        run: docker pull ghcr.io/${{ github.repository }}:serving-${{ github.event.workflow_run.head_sha }}

      - name: Start gateway on :8000
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
        run: |
          docker rm -f model-gateway || true
          docker run -d --name model-gateway -p 8000:8000 \
            -e MLFLOW_TRACKING_URI="${MLFLOW_TRACKING_URI}" \
            -e MODEL_NAME="taxi-duration" \
            -e MODEL_ALIAS_STABLE="production" \
            -e MODEL_ALIAS_CAND="staging" \
            ghcr.io/${{ github.repository }}:serving-${{ github.event.workflow_run.head_sha }}
          sleep 2
          curl -fsS http://localhost:8000/health

      - name: Check if Production alias exists
        id: hasprod
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
        run: |
          docker run --rm --network host \
            -e MLFLOW_TRACKING_URI="${MLFLOW_TRACKING_URI}" \
            -v "$PWD:/w" -w /w python:3.11-slim bash -lc \
            "python -m pip install -q mlflow>=2.8 && python scripts/mlops.py has-production" > has_prod.txt
          echo "HAS_PROD=$(tr -d '\n\r' < has_prod.txt)" >> $GITHUB_OUTPUT

      # First run: 100% candidate, then promote
      - name: First run → 100% candidate immediately
        if: ${{ steps.hasprod.outputs.HAS_PROD == '0' }}
        run: |
          curl -fsS -X POST http://localhost:8000/admin/weights \
            -H "Content-Type: application/json" \
            -d '{"cand_weight":100}'
          curl -fsS http://localhost:8000/health

      - name: First run → promote staging → production
        if: ${{ steps.hasprod.outputs.HAS_PROD == '0' }}
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
        run: |
          docker run --rm --network host \
            -e MLFLOW_TRACKING_URI="${MLFLOW_TRACKING_URI}" \
            -v "$PWD:/w" -w /w python:3.11-slim bash -lc \
            "python -m pip install -q mlflow>=2.8 && python scripts/mlops.py promote-staging-to-production"

      # Subsequent runs: 10% → soak 5m → 50% → soak 5m → 100%, then promote
      - name: Canary 10%
        if: ${{ steps.hasprod.outputs.HAS_PROD == '1' }}
        run: |
          curl -fsS -X POST http://localhost:8000/admin/weights \
            -H "Content-Type: application/json" \
            -d '{"stable_weight":90,"cand_weight":10}'
          curl -fsS http://localhost:8000/health

      - name: Soak at 10% (5 minutes)
        if: ${{ steps.hasprod.outputs.HAS_PROD == '1' }}
        run: sleep 200

      - name: Canary 50%
        if: ${{ steps.hasprod.outputs.HAS_PROD == '1' }}
        run: |
          curl -fsS -X POST http://localhost:8000/admin/weights \
            -H "Content-Type: application/json" \
            -d '{"cand_weight":50}'
          curl -fsS http://localhost:8000/health

      - name: Soak at 50% (5 minutes)
        if: ${{ steps.hasprod.outputs.HAS_PROD == '1' }}
        run: sleep 200

      - name: Canary 100%
        if: ${{ steps.hasprod.outputs.HAS_PROD == '1' }}
        run: |
          curl -fsS -X POST http://localhost:8000/admin/weights \
            -H "Content-Type: application/json" \
            -d '{"cand_weight":100}'
          curl -fsS http://localhost:8000/health

      - name: Promote staging → production
        if: ${{ steps.hasprod.outputs.HAS_PROD == '1' }}
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
        run: |
          docker run --rm --network host \
            -e MLFLOW_TRACKING_URI="${MLFLOW_TRACKING_URI}" \
            -v "$PWD:/w" -w /w python:3.11-slim bash -lc \
            "python -m pip install -q mlflow>=2.8 && python scripts/mlops.py promote-staging-to-production"

