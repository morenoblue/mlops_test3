name: CI Train
run-name: "${{ github.workflow }}"
permissions: { contents: read, packages: write }

on:

  workflow_dispatch:

  push:
    paths:
      - "src/train.py"
      - ".github/workflows/ci_train.yml"

  pull_request:

jobs:

  add-the-training-image-to-the-repo:

    runs-on: [self-hosted, trainer]

    env:
      TRAIN_IMAGE_SHA: ghcr.io/${{ github.repository }}:train-${{ github.sha }}
      TRAIN_IMAGE_LATEST: ghcr.io/${{ github.repository }}:train-latest
      MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}

    steps:
      - name: Clone the repo to the runner vm
        uses: actions/checkout@v4

      - name: Install docker on the vm
        uses: docker/setup-buildx-action@v3

      - name: Build the training image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          load: true
          tags: ${{ env.TRAIN_IMAGE_SHA }}

      - name: Smoke test the training image
        run: |
          docker run --rm \
            -e MLFLOW_TRACKING_URI="${MLFLOW_TRACKING_URI}" \
            -e MLFLOW_EXPERIMENT_NAME="taxi-duration-ci" \
            -e MODEL_NAME="taxi-duration-ci" \
            -e DATA_PATH="src/data/smoke_sample.parquet" \
            -e TRAIN_NROWS="256" \
            "$TRAIN_IMAGE_SHA"

      - name: Tag training image as latest
        run: docker tag "$TRAIN_IMAGE_SHA" "$TRAIN_IMAGE_LATEST"

      - name: Login GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push training images
        if: github.event_name != 'pull_request'
        run: |
          docker push "$TRAIN_IMAGE_SHA"
          docker push "$TRAIN_IMAGE_LATEST"

