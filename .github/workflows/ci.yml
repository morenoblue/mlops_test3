########################################################################################################################
# Dummy code version, just to avoid increasing wait times between the iterations since we are focusing on the cd.yml rn:
########################################################################################################################

# name: CI
# run-name: "${{ github.workflow }}"
# permissions: write-all
#
# on:
#   workflow_dispatch:
#   push:
#   pull_request:
#
# jobs:
#   dummy:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Fast dummy CI
#         run: echo "Dummy CI run â€“ just here to trigger CD"

########################################################################################################################
# Original code:
########################################################################################################################

# name: CI
# run-name: "${{ github.workflow }}"
# permissions: { contents: read, packages: write }
#
# on:
#   workflow_dispatch:
#   push:
#   pull_request:
#
# jobs:
#
#   add-required-images-to-the-repo:
#
#     runs-on: ubuntu-latest
#
#     env:
#       TRAIN_IMAGE: ghcr.io/${{ github.repository }}:train-${{ github.sha }}
#       SERVE_IMAGE: ghcr.io/${{ github.repository }}:serve-${{ github.sha }}
#
#     steps:
#
#       - name: Clone the repo to the runner vm
#         uses: actions/checkout@v4
#
#       - name: Install docker on the vm
#         uses: docker/setup-buildx-action@v3
#
#       - name: Build the training image
#         uses: docker/build-push-action@v6
#         with:
#           context: .
#           file: Dockerfile
#           load: true
#           tags: ${{ env.TRAIN_IMAGE }}
#
#       - name: Smoke test the training image
#         run: |
#           mkdir -p mlruns
#           docker run --rm                                         \
#                      -v "$PWD/mlruns:/mlruns"                     \
#                      -e MLFLOW_TRACKING_URI="file:/mlruns"        \
#                      -e DATA_PATH="src/data/smoke_sample.parquet" \
#                      -e TRAIN_NROWS="256"                         \
#                      "$TRAIN_IMAGE"
#
#       - name: Build the serving image
#         uses: docker/build-push-action@v6
#         with:
#           context: .
#           file: Dockerfile.serve
#           load: true
#           tags: ${{ env.SERVE_IMAGE }} 
#
#       - name: Start the server
#         run: |
#           docker run -d                                    \
#                      --name serve                          \
#                      -p 8000:8000                          \
#                      -v "$PWD/mlruns:/mlruns"              \
#                      -e MLFLOW_TRACKING_URI="file:/mlruns" \
#                      "$SERVE_IMAGE"
#
#       - name: Check the server's health
#         uses: jtalk/url-health-check-action@v3
#         with:
#           url: http://localhost:8000/health
#           max-attempts: 15
#           retry-delay: 2s
#
#       - name: Smoke test the server
#         run: |
#           curl -fsS -X POST "http://localhost:8000/predict" \
#                -H "Content-Type: application/json"          \
#                -d '{
#                      "records": [
#                        {
#                          "vendor_id": 1,
#                          "passenger_count": 1,
#                          "trip_distance": 3.2,
#                          "pickup_longitude": -73.985,
#                          "pickup_latitude": 40.758,
#                          "dropoff_longitude": -73.981,
#                          "dropoff_latitude": 40.752,
#                          "pickup_datetime": "2013-01-01 00:00:00",
#                          "dropoff_datetime": "2013-01-01 00:10:00"
#                        }
#                      ]
#                    }'
#
#       - name: Cleanup serve
#         if: always()
#         run: docker rm -f serve
#
#       - name: Login GHCR
#         if: github.event_name != 'pull_request'
#         uses: docker/login-action@v3
#         with:
#           registry: ghcr.io
#           username: ${{ github.actor }}
#           password: ${{ secrets.GITHUB_TOKEN }}
#
#       - name: Push images
#         if: github.event_name != 'pull_request'
#         run: |
#           docker push "$TRAIN_IMAGE"
#           docker push "$SERVE_IMAGE"
