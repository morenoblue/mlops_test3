name: CI Serve
run-name: "${{ github.workflow }}"
permissions: { contents: read, packages: write }

on:
  workflow_dispatch:

  workflow_run:
    workflows: ["CI Train"]
    types:
      - completed

jobs:
  add-the-serving-image-to-the-repo:
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    env:
      IMAGE_REPO: ghcr.io/${{ github.repository }}
      SERVE_IMAGE: ghcr.io/${{ github.repository }}:serve-${{ github.sha }}

    steps:
      - name: Clone the repo to the runner vm
        uses: actions/checkout@v4

      - name: Install docker on the vm
        uses: docker/setup-buildx-action@v3

      - name: Decide which training image to use
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "TRAIN_IMAGE=${{ env.IMAGE_REPO }}:train-${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_ENV"
          else
            echo "TRAIN_IMAGE=${{ env.IMAGE_REPO }}:train-latest" >> "$GITHUB_ENV"
          fi

      - name: Build the serving image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.serve
          load: true
          tags: ${{ env.SERVE_IMAGE }}

      - name: Start the server
        run: |
          docker run -d                                    \
                     --name serve                          \
                     -p 8000:8000                          \
                     -e MLFLOW_TRACKING_URI="file:/mlruns" \
                     -e MODEL_ALIAS_STABLE="staging"       \
                     "$SERVE_IMAGE"


      - name: Check the server's health
        run: |
          max_retries=15
          for i in $(seq 1 "$max_retries"); do
            echo "Checking /health (attempt $i/$max_retries)..."
            if curl -fsS http://localhost:8000/health > /dev/null; then
              echo "Server is healthy ✅"
              exit 0
            fi
            sleep 2
          done

          echo "Server did not become healthy in time ❌"
          echo "=== Server logs ==="
          docker logs serve || true
          exit 1

      - name: Smoke test the server
        run: |
          curl -fsS -X POST "http://localhost:8000/predict" \
               -H "Content-Type: application/json"          \
               -d '{
                     "records": [
                       {
                         "vendor_id": 1,
                         "passenger_count": 1,
                         "trip_distance": 3.2,
                         "pickup_longitude": -73.985,
                         "pickup_latitude": 40.758,
                         "dropoff_longitude": -73.981,
                         "dropoff_latitude": 40.752,
                         "pickup_datetime": "2013-01-01 00:00:00",
                         "dropoff_datetime": "2013-01-01 00:10:00"
                       }
                     ]
                   }'

      - name: Cleanup serve
        if: always()
        run: docker rm -f serve

      - name: Login GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push serving image
        if: github.event_name != 'pull_request'
        run: docker push "$SERVE_IMAGE"

