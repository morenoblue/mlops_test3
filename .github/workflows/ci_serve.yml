name: CI Serve
run-name: "${{ github.workflow }}"
permissions: { contents: read, packages: write }

on:
  workflow_dispatch:

  workflow_run:
    workflows: ["CI Train"]
    types:
      - completed

jobs:
  add-the-serving-image-to-the-repo:

    # note(@morenoblue): The `if` below means run this thing always for workflow_dispatch. For workflow_run, only
    #                    run only if the upstream workflow (CI Train) succeeded

    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'

    runs-on: [self-hosted, trainer]

    env:
      SERVE_IMAGE_CURRENT: ghcr.io/${{ github.repository }}:serve-${{ github.sha }}
      SERVE_IMAGE_LATEST: ghcr.io/${{ github.repository }}:serve-latest

      MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
      MODEL_NAME: taxi-duration-ci

    steps:
      - name: Clone the repo to the runner vm
        uses: actions/checkout@v4

      # - name: Install docker on the vm
      #   uses: docker/setup-buildx-action@v3

      - name: Build the serving image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.serve
          load: true
          tags: ${{ env.SERVE_IMAGE_CURRENT }}

      - name: Tag serving image as latest
        run: docker tag "$SERVE_IMAGE_CURRENT" "$SERVE_IMAGE_LATEST"

      - name: Start the server
        run: |
          docker run -d                                     \
            --name serve                                    \
            -p 8000:8000                                    \
            -e MLFLOW_TRACKING_URI="${MLFLOW_TRACKING_URI}" \
            -e MODEL_NAME="${MODEL_NAME}"                   \
            -e MODEL_ALIAS_STABLE="staging"                 \
            "$SERVE_IMAGE_CURRENT"

      - name: Check the server's health
        run: |
          max_retries=15
          for i in $(seq 1 "$max_retries"); do
            echo "Checking /health (attempt $i/$max_retries)..."
            if curl -fsS http://localhost:8000/health > /dev/null; then
              echo "Server is healthy ✅"
              exit 0
            fi
            sleep 2
          done

          echo "Server did not become healthy in time ❌"
          echo "=== Server logs ==="
          docker logs serve || true
          exit 1

      - name: Smoke test the server
        run: |
          curl -sS -X POST "http://localhost:8000/predict" \
               -H "Content-Type: application/json"         \
               -d '{
                     "records": [
                       {
                         "vendor_id": 1,
                         "pickup_datetime": "2010-01-15T08:30:00",
                         "dropoff_datetime": "2010-01-15T08:45:00",
                         "passenger_count": 1,
                         "trip_distance": 2.3,
                         "pickup_longitude": -73.99,
                         "pickup_latitude": 40.73,
                         "rate_code": 1,
                         "dropoff_longitude": -73.98,
                         "dropoff_latitude": 40.75,
                         "fare_amount": 12.5,
                         "surcharge": 0.5,
                         "mta_tax": 0.5,
                         "tip_amount": 2.0,
                         "tolls_amount": 0.0,
                         "total_amount": 15.5,
                         "store_and_fwd_flag": "N",
                         "payment_type": "CRD"
                       }
                     ]
                   }'

      - name: Dump serve logs on failure
        if: failure()
        run: docker logs serve || true

      - name: Cleanup serve
        if: always()
        run: docker rm -f serve

      - name: Login GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push serving images
        if: github.event_name != 'pull_request'
        run: |
          docker push "$SERVE_IMAGE_CURRENT"
          docker push "$SERVE_IMAGE_LATEST"

